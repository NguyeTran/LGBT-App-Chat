<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <title>TruEon Video Chat</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        /* --- CSS RESET & GLOBAL --- */
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', Helvetica, Arial, sans-serif; background: #f0f2f5; margin: 0; color: #050505; height: 100vh; display: flex; flex-direction: column; }
        
        /* --- HEADER --- */
        .header { background: #fff; padding: 0 20px; height: 60px; display: flex; align-items: center; box-shadow: 0 1px 2px rgba(0,0,0,0.1); z-index: 100; position: sticky; top: 0; }
        .logo { font-size: 24px; font-weight: bold; color: #ff6b6b; margin-right: 40px; display: flex; align-items: center; }
        .logo span { color: #ccc; font-weight: 300; margin-left: 5px; }
        .search-bar { background: #f0f2f5; border-radius: 20px; padding: 8px 15px; width: 300px; display: flex; align-items: center; color: #65676b; }
        .search-bar input { border: none; background: transparent; outline: none; margin-left: 10px; width: 100%; }
        .user-menu { margin-left: auto; display: flex; align-items: center; gap: 10px; font-weight: 600; }
        .my-avatar { width: 36px; height: 36px; border-radius: 50%; background: #ddd; object-fit: cover; }

        /* --- MAIN LAYOUT (GRID) --- */
        .main-container { display: flex; flex: 1; overflow: hidden; max-width: 1400px; margin: 0 auto; width: 100%; }
        
        /* SIDEBAR TR√ÅI */
        .sidebar-left { width: 280px; padding: 20px 10px; overflow-y: auto; display: none; /* Hi·ªán tr√™n Desktop */ }
        .menu-item { display: flex; align-items: center; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: 500; color: #050505; transition: 0.2s; }
        .menu-item:hover { background: #e4e6eb; }
        .menu-icon { width: 30px; height: 30px; margin-right: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; }

        /* SIDEBAR PH·∫¢I (B·∫†N B√à) */
        .sidebar-right { width: 280px; padding: 20px 10px; border-left: 1px solid #ddd; background: #fff; overflow-y: auto; display: none; }
        .friend-title { font-weight: 600; color: #65676b; margin-bottom: 10px; font-size: 15px; }
        .friend-item { display: flex; align-items: center; padding: 8px; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .friend-item:hover { background: #f2f2f2; }
        .friend-avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; margin-right: 12px; border: 2px solid #fff; box-shadow: 0 0 2px rgba(0,0,0,0.2); }
        .friend-name { font-size: 14px; font-weight: 500; }
        .friend-status { width: 8px; height: 8px; background: #31a24c; border-radius: 50%; margin-left: auto; }

        /* CONTENT CENTER */
        .content-center { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; align-items: center; }

        /* SCREENS */
        .screen { display: none; width: 100%; max-width: 600px; }
        .active { display: block; }

        /* CARD STYLE */
        .card { background: #fff; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); padding: 20px; margin-bottom: 20px; border: 1px solid #ddd; }

        /* LOGIN SCREEN */
        .login-box h3 { margin-top: 0; color: #ff6b6b; }
        .select-style { width: 100%; padding: 12px; border-radius: 6px; border: 1px solid #ccc; margin: 15px 0; font-size: 16px; }
        
        /* CHAT & VIDEO UI */
        .chat-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .status-dot { color: #31a24c; font-weight: bold; font-size: 14px; display: flex; align-items: center; gap: 5px; }
        .btn-report { background: #ff4444; color: white; border: none; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold; }

        /* VIDEO AREA */
        .video-wrapper { background: #000; border-radius: 10px; overflow: hidden; display: flex; height: 220px; margin-bottom: 0; border: 1px solid #333; }
        video { width: 50%; height: 100%; object-fit: cover; background: #222; }
        
        /* STATUS BAR (Xanh d∆∞∆°ng) */
        .status-bar { background: #2196f3; color: white; text-align: center; padding: 5px; font-size: 13px; font-weight: bold; display: flex; justify-content: center; align-items: center; gap: 5px; border-bottom-left-radius: 8px; border-bottom-right-radius: 8px; margin-bottom: 15px; }

        /* CHAT AREA */
        #messages { height: 300px; overflow-y: auto; padding: 10px; background: #fff; border: 1px solid #eee; border-radius: 8px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 8px; }
        
        .msg-row { display: flex; width: 100%; }
        .msg-bubble { max-width: 70%; padding: 8px 14px; border-radius: 18px; font-size: 15px; word-wrap: break-word; line-height: 1.4; }
        
        /* Tin nh·∫Øn c·ªßa t√¥i (H·ªìng) */
        .msg-row.me { justify-content: flex-end; }
        .msg-row.me .msg-bubble { background: #ff6b6b; color: white; border-bottom-right-radius: 4px; }
        
        /* Tin nh·∫Øn ƒë·ªëi ph∆∞∆°ng (X√°m) */
        .msg-row.partner { justify-content: flex-start; }
        .msg-row.partner .msg-bubble { background: #e4e6eb; color: #050505; border-bottom-left-radius: 4px; }
        
        .system-msg { text-align: center; color: #888; font-size: 12px; font-style: italic; width: 100%; margin: 5px 0; }

        /* INPUT AREA */
        .input-area { display: flex; gap: 10px; align-items: center; border-top: 1px solid #eee; padding-top: 15px; }
        .input-style { flex: 1; padding: 10px 15px; border-radius: 20px; border: 1px solid #ccc; outline: none; background: #f0f2f5; }
        .btn-pink { background: #ff6b6b; color: white; border: none; padding: 10px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; transition: 0.2s; white-space: nowrap; }
        .btn-pink:hover { background: #ff5252; }
        .btn-cam { width: 100%; margin-bottom: 0; border-radius: 0; background: #4caf50; padding: 10px; }

        /* RESPONSIVE */
        @media (min-width: 900px) {
            .sidebar-left, .sidebar-right { display: block; }
        }
    </style>
</head>
<body>

    <div class="header">
        <div class="logo">
            TruEon
        </div>
        <div class="search-bar">
            üîç <input type="text" placeholder="C∆∞ng m√∫n t√¨m g√¨ h·ª≠ :>">
        </div>
        <div class="user-menu">
            <img src="https://i.pravatar.cc/150?img=12" class="my-avatar">
            <span>RandomUser1109</span>
        </div>
    </div>

    <div class="main-container">
        
        <div class="sidebar-left">
            <div class="menu-item"><span class="menu-icon">üë•</span> B·∫°n b√®</div>
            <div class="menu-item"><span class="menu-icon">‚ù§Ô∏è</span> K·ªâ ni·ªám</div>
            <div class="menu-item"><span class="menu-icon">üèòÔ∏è</span> Nh√≥m</div>
            <div class="menu-item"><span class="menu-icon">üö©</span> Trang</div>
            <div class="menu-item"><span class="menu-icon">üìÖ</span> S·ª± ki·ªán</div>
            <div class="menu-item"><span class="menu-icon">üõí</span> Market</div>
            <div class="menu-item" style="color: #ff6b6b;"><span class="menu-icon">üíé</span> Premium</div>
        </div>

        <div class="content-center">
            
            <div id="login-screen" class="screen active card login-box">
                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                    <div style="width: 5px; height: 40px; background: #ff6b6b; border-radius: 5px;"></div>
                    <div>
                        <h3>LGBT Chat Connect</h3>
                        <span style="font-size: 13px; color: #666;">Ch√†o b·∫°n, h√£y ch·ªçn c·ªông ƒë·ªìng b·∫°n mu·ªën k·∫øt n·ªëi:</span>
                    </div>
                </div>
                
                <select id="userType" class="select-style">
                    <option value="gay">Gay (Nam - Nam)</option>
                    <option value="les">Lesbian (N·ªØ - N·ªØ)</option>
                    <option value="other">C·ªông ƒë·ªìng kh√°c</option>
                </select>
                
                <button class="btn-pink" style="width: 100%; border-radius: 8px;" onclick="enterApp()">B·∫Øt ƒë·∫ßu tham gia</button>
            </div>

            <div id="match-screen" class="screen card" style="text-align: center; padding: 50px;">
                <div style="font-size: 50px; margin-bottom: 20px;">üîç</div>
                <h3 style="color: #444;">ƒêang t√¨m ng∆∞·ªùi l·∫°...</h3>
                <p style="color: #888;">Vui l√≤ng ƒë·ª£i h·ªá th·ªëng gh√©p ƒë√¥i.</p>
                <button onclick="location.reload()" style="background: #e4e6eb; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-weight: 600;">H·ªßy t√¨m ki·∫øm</button>
            </div>

            <div id="chat-screen" class="screen card" style="padding: 15px;">
                
                <div class="chat-header">
                    <div class="status-dot">‚óè ƒêang online v·ªõi ng∆∞·ªùi l·∫°</div>
                    <button class="btn-report" onclick="reportUser()">‚ö†Ô∏è B√°o c√°o</button>
                </div>

                <div class="video-wrapper">
                    <video id="localVideo" muted playsinline autoplay></video>
                    <video id="remoteVideo" playsinline autoplay controls></video>
                </div>
                
                <button id="btn-cam" class="btn-pink btn-cam" onclick="startVideoCall()">üìπ B·∫¨T CAMERA & MIC</button>
                <div id="status-text" class="status-bar" style="display:none;">‚è≥ ƒêang k·∫øt n·ªëi video...</div>

                <div id="messages">
                    </div>

                <div class="input-area">
                    <input type="text" id="inputMsg" class="input-style" placeholder="Nh·∫≠p tin nh·∫Øn..." onkeydown="if(event.key==='Enter') sendMsg()">
                    <button class="btn-pink" onclick="sendMsg()">G·ª≠i</button>
                </div>
                <div style="text-align: center; margin-top: 10px;">
                    <span onclick="location.reload()" style="font-size: 12px; color: #888; cursor: pointer; text-decoration: underline;">Tho√°t cu·ªôc tr√≤ chuy·ªán</span>
                </div>
            </div>

        </div>

        <div class="sidebar-right">
            <div class="friend-title">B·∫°n b√® c·ªßa b·∫°n</div>
            
            <div class="friend-item">
                <img src="https://i.pravatar.cc/150?img=68" class="friend-avatar">
                <span class="friend-name">MrGay123</span>
                <div class="friend-status"></div>
            </div>
            
            <div class="friend-item">
                <img src="https://i.pravatar.cc/150?img=33" class="friend-avatar">
                <span class="friend-name">Ivanovich Cutonhuphich</span>
                <div class="friend-status"></div>
            </div>

            <div class="friend-item">
                <img src="https://i.pravatar.cc/150?img=11" class="friend-avatar">
                <span class="friend-name">Quyhoabaodienabc</span>
                <div class="friend-status"></div>
            </div>

            <div class="friend-item">
                <img src="https://i.pravatar.cc/150?img=59" class="friend-avatar">
                <span class="friend-name">R·ª≠a chim g√°c ƒë√°i</span>
                <div class="friend-status" style="background: #ccc;"></div>
            </div>

            <div class="friend-item">
                <img src="https://i.pravatar.cc/150?img=5" class="friend-avatar">
                <span class="friend-name">H·ªìng t·ªâ t·ªâ</span>
                <div class="friend-status"></div>
            </div>
             <div class="friend-item">
                <img src="https://i.pravatar.cc/150?img=8" class="friend-avatar">
                <span class="friend-name">H·ªìng ƒë·ªá ƒë·ªá</span>
                <div class="friend-status"></div>
            </div>
        </div>

    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io({ transports: ['websocket', 'polling'] });
        let currentRoomID = null;
        let myStream = null;
        let myPeerID = null;

        // C·∫§U H√åNH TURN SERVER (M·∫†NH M·∫º)
        const myPeer = new Peer(undefined, {
            config: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { 
                        urls: "turn:openrelay.metered.ca:80",
                        username: "openrelayproject",
                        credential: "openrelayproject"
                    },
                    { 
                        urls: "turn:openrelay.metered.ca:443",
                        username: "openrelayproject",
                        credential: "openrelayproject"
                    },
                    { 
                        urls: "turn:openrelay.metered.ca:443?transport=tcp",
                        username: "openrelayproject",
                        credential: "openrelayproject"
                    }
                ]
            }
        });

        myPeer.on('open', id => { myPeerID = id; console.log("ID:", id); });

        // NH·∫¨N CU·ªòC G·ªåI
        myPeer.on('call', call => {
            navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
                myStream = stream;
                addVideo('localVideo', stream);
                call.answer(stream);
                call.on('stream', userStream => addVideo('remoteVideo', userStream));
            }).catch(e => alert("Vui l√≤ng c·∫•p quy·ªÅn Camera/Mic!"));
        });

        // G·ªåI ƒêI
        function startVideoCall() {
            if(!myPeerID) return alert("ƒêang k·∫øt n·ªëi server... ƒê·ª£i 2s");
            navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
                myStream = stream;
                addVideo('localVideo', stream);
                socket.emit('share_video_id', { roomID: currentRoomID, peerID: myPeerID });
                
                // UI Update
                document.getElementById('btn-cam').style.display = 'none';
                document.getElementById('status-text').style.display = 'block';
                addMsg('System', 'ƒêang k·∫øt n·ªëi video...', true);
            }).catch(e => alert("Kh√¥ng b·∫≠t ƒë∆∞·ª£c Camera!"));
        }

        socket.on('receive_video_id', (partnerID) => {
            addMsg('System', 'ƒê·ªëi ph∆∞∆°ng ƒë√£ b·∫≠t cam...', false);
            if(myStream) {
                connectToPeer(partnerID, myStream);
            } else {
                navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
                    myStream = stream;
                    addVideo('localVideo', stream);
                    connectToPeer(partnerID, stream);
                });
            }
        });

        function connectToPeer(partnerID, stream) {
            setTimeout(() => {
                const call = myPeer.call(partnerID, stream);
                call.on('stream', remoteStream => addVideo('remoteVideo', remoteStream));
                // ·∫®n n√∫t cam khi k·∫øt n·ªëi xong
                document.getElementById('btn-cam').style.display = 'none';
                document.getElementById('status-text').innerText = "ƒê√£ k·∫øt n·ªëi video";
                document.getElementById('status-text').style.display = 'block';
                document.getElementById('status-text').style.background = '#4caf50';
            }, 1000);
        }

        function addVideo(id, stream) {
            const video = document.getElementById(id);
            video.srcObject = stream;
            if (id === 'localVideo') {
                video.muted = true;
                video.controls = false;
            } else {
                video.muted = false;
                video.controls = true;
                video.play().catch(e => console.log("Autoplay blocked"));
            }
        }

        // --- APP LOGIC ---
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function enterApp() {
            const type = document.getElementById('userType').value;
            showScreen('match-screen');
            socket.emit('find_match', { type });
        }

        socket.on('match_found', (roomID) => {
            currentRoomID = roomID;
            showScreen('chat-screen');
            addMsg('System', 'ƒê√£ k·∫øt n·ªëi! Say hi üëã', false);
        });

        function sendMsg() {
            const input = document.getElementById('inputMsg');
            const msg = input.value;
            if(msg && currentRoomID) {
                addMsg('B·∫°n', msg, true);
                socket.emit('send_msg', { roomID: currentRoomID, msg });
                input.value = '';
            }
        }

        socket.on('receive_msg', (msg) => { addMsg('Ng∆∞·ªùi l·∫°', msg, false); });

        function addMsg(sender, text, isMe) {
            const row = document.createElement('div');
            row.className = `msg-row ${isMe ? 'me' : 'partner'}`;
            
            if(sender === 'System') {
                const sysDiv = document.createElement('div');
                sysDiv.className = 'system-msg';
                sysDiv.innerText = text;
                document.getElementById('messages').appendChild(sysDiv);
            } else {
                const bubble = document.createElement('div');
                bubble.className = 'msg-bubble';
                bubble.innerText = text;
                row.appendChild(bubble);
                document.getElementById('messages').appendChild(row);
            }
            const box = document.getElementById('messages');
            box.scrollTop = box.scrollHeight;
        }

        function reportUser() {
            if(confirm("B√°o c√°o v√† tho√°t?")) {
                socket.emit('report_user', { roomID: currentRoomID });
                location.reload();
            }
        }
        socket.on('chat_ended', (msg) => { alert(msg); location.reload(); });
    </script>
</body>
</html>